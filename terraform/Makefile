.PHONY: help init plan apply destroy validate fmt check clean

# VariÃ¡veis
TF_VAR_FILE := terraform.tfvars

# Cores para output
RED := \033[31m
GREEN := \033[32m
YELLOW := \033[33m
BLUE := \033[34m
RESET := \033[0m

help: ## Mostra esta ajuda
	@echo "$(BLUE)Comandos disponÃ­veis:$(RESET)"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  $(GREEN)%-15s$(RESET) %s\n", $$1, $$2}'

check-vars: ## Verifica se o arquivo de variÃ¡veis existe
	@if [ ! -f $(TF_VAR_FILE) ]; then \
		echo "$(RED)âŒ Arquivo $(TF_VAR_FILE) nÃ£o encontrado!$(RESET)"; \
		echo "$(YELLOW)ðŸ’¡ Copie o arquivo de exemplo:$(RESET)"; \
		echo "   cp terraform.tfvars.example $(TF_VAR_FILE)"; \
		echo "   Depois edite o arquivo com suas configuraÃ§Ãµes."; \
		exit 1; \
	fi
	@echo "$(GREEN)âœ… Arquivo de variÃ¡veis encontrado$(RESET)"

init: ## Inicializa o Terraform
	@echo "$(BLUE)ðŸš€ Inicializando Terraform...$(RESET)"
	terraform init
	@echo "$(GREEN)âœ… Terraform inicializado$(RESET)"

validate: init ## Valida a configuraÃ§Ã£o do Terraform
	@echo "$(BLUE)ðŸ” Validando configuraÃ§Ã£o...$(RESET)"
	terraform validate
	@echo "$(GREEN)âœ… ConfiguraÃ§Ã£o vÃ¡lida$(RESET)"

fmt: ## Formata os arquivos Terraform
	@echo "$(BLUE)ðŸŽ¨ Formatando arquivos...$(RESET)"
	terraform fmt -recursive
	@echo "$(GREEN)âœ… Arquivos formatados$(RESET)"

plan: check-vars validate ## Mostra o plano de execuÃ§Ã£o
	@echo "$(BLUE)ðŸ“‹ Gerando plano de execuÃ§Ã£o...$(RESET)"
	terraform plan -var-file=$(TF_VAR_FILE)

apply: check-vars validate ## Aplica as mudanÃ§as
	@echo "$(YELLOW)âš ï¸  Aplicando mudanÃ§as...$(RESET)"
	terraform apply -var-file=$(TF_VAR_FILE)
	@echo "$(GREEN)âœ… MudanÃ§as aplicadas com sucesso!$(RESET)"

apply-auto: check-vars validate ## Aplica as mudanÃ§as automaticamente (sem confirmaÃ§Ã£o)
	@echo "$(YELLOW)âš ï¸  Aplicando mudanÃ§as automaticamente...$(RESET)"
	terraform apply -var-file=$(TF_VAR_FILE) -auto-approve
	@echo "$(GREEN)âœ… MudanÃ§as aplicadas com sucesso!$(RESET)"

destroy: check-vars ## DestrÃ³i os recursos
	@echo "$(RED)ðŸ’¥ ATENÃ‡ÃƒO: Isso irÃ¡ destruir todos os recursos!$(RESET)"
	@echo "$(YELLOW)Pressione Ctrl+C para cancelar ou Enter para continuar...$(RESET)"
	@read
	terraform destroy -var-file=$(TF_VAR_FILE)

show: ## Mostra o estado atual
	@echo "$(BLUE)ðŸ“Š Estado atual dos recursos:$(RESET)"
	terraform show

output: ## Mostra os outputs
	@echo "$(BLUE)ðŸ“¤ Outputs:$(RESET)"
	terraform output

clean: ## Remove arquivos temporÃ¡rios
	@echo "$(BLUE)ðŸ§¹ Limpando arquivos temporÃ¡rios...$(RESET)"
	rm -rf .terraform/
	rm -f .terraform.lock.hcl
	rm -f terraform.tfstate.backup
	rm -f *tfplan*
	@echo "$(GREEN)âœ… Limpeza concluÃ­da$(RESET)"

setup: ## ConfiguraÃ§Ã£o inicial completa
	@echo "$(BLUE)ðŸ”§ ConfiguraÃ§Ã£o inicial...$(RESET)"
	@if [ ! -f $(TF_VAR_FILE) ]; then \
		echo "$(YELLOW)ðŸ“ Criando arquivo de variÃ¡veis...$(RESET)"; \
		cp terraform.tfvars.example $(TF_VAR_FILE); \
		echo "$(GREEN)âœ… Arquivo $(TF_VAR_FILE) criado$(RESET)"; \
		echo "$(YELLOW)âš ï¸  IMPORTANTE: Edite o arquivo $(TF_VAR_FILE) com suas configuraÃ§Ãµes!$(RESET)"; \
	else \
		echo "$(GREEN)âœ… Arquivo de variÃ¡veis jÃ¡ existe$(RESET)"; \
	fi
	make init
	make validate
	@echo "$(GREEN)ðŸŽ‰ ConfiguraÃ§Ã£o inicial concluÃ­da!$(RESET)"
	@echo "$(BLUE)PrÃ³ximos passos:$(RESET)"
	@echo "  1. Edite o arquivo $(TF_VAR_FILE) com suas configuraÃ§Ãµes"
	@echo "  2. Execute: make plan"
	@echo "  3. Execute: make apply"

status: ## Mostra o status dos recursos
	@echo "$(BLUE)ðŸ“Š Status dos recursos:$(RESET)"
	@terraform state list 2>/dev/null || echo "$(YELLOW)Nenhum recurso encontrado$(RESET)"

refresh: ## Atualiza o estado
	@echo "$(BLUE)ðŸ”„ Atualizando estado...$(RESET)"
	terraform refresh -var-file=$(TF_VAR_FILE)
	@echo "$(GREEN)âœ… Estado atualizado$(RESET)"